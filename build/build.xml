<project name="org.textway.lapg">

	<property file="lapg.properties" />

	<target name="clean">
		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="${buildDirectory}">
				<include name="**/**"/>
			</fileset>
		</delete>
	</target>
	
	<target name="eclipseVars">
		<path id="launcher.plugin.id">
			<fileset dir="${baseLocation}/plugins" includes="org.eclipse.equinox.launcher_*.jar"/>
		</path>
		<path id="builder.id">
	    	<dirset dir="${baseLocation}/plugins" includes="org.eclipse.pde.build_*"/>
	    </path>
		<property name="launcher.plugin" location="${toString:launcher.plugin.id}"/>
		<property name="builder.plugin" location="${toString:builder.id}"/>
		<property name="template.build.properties" location="${builder.plugin}/templates/headless-build/build.properties"/>
		<property name="build.xml.script" location="${builder.plugin}/scripts/build.xml"/>
	</target>

	<target name="init" depends="clean, eclipseVars">
		<property name="deploy.dir" location="${deploy.target}"/>
		<property name="buildDirectoryPath" location="${buildDirectory}"/>

		<path id="buildDirectory.id">
			<pathelement location="${buildDirectoryPath}"/>
		</path>
		<pathconvert property="buildDirectoryUnixPath" targetos="unix" refid="buildDirectory.id" />

		<property name="p2.build.repo" location="${buildDirectoryUnixPath}/repo"/>
		
		<mkdir dir="${buildDirectory}"/>
		
		<copy todir="${buildDirectory}" includeemptydirs="true">
			<fileset dir="${basedir}/..">
				<include name="features/**"/>
				<include name="plugins/**"/>
				<exclude name="**/bin/**"/>
			</fileset>
		</copy>
		
		<copy file="${basedir}/customTargets.xml" todir="${buildDirectory}">
			<fileset dir="${basedir}" includes="custom*.xml"/>
		</copy>
		<copy file="${basedir}/lapg.properties" tofile="${buildDirectory}/build.properties"/>
		
		<propertyfile file="${buildDirectory}/build.properties">
			<entry key="baseLocation" value="${baseLocation}"/>
			<entry key="buildDirectory" value="${buildDirectoryUnixPath}"/>
			<entry key="JavaSE-1.6" value="${java.home}/lib/rt.jar"/>
			<entry key="p2.build.repo" value="file:${p2.build.repo}"/>
			<entry key="p2.repo.path" value="${p2.build.repo}"/>
			<entry key="deploy.target" value="${deploy.dir}"/>
		</propertyfile>
	</target>

	<target name="deploy" depends="init">
		<java jar="${launcher.plugin}" fork="true">
			<arg line="-application org.eclipse.ant.core.antRunner -buildfile ${build.xml.script} -Dbuilder=${buildDirectoryUnixPath}"/>
		</java>
		<zip destfile="${buildDirectory}/lapg-update-site.zip"
			basedir="${deploy.target}"/>
	</target>
</project>
